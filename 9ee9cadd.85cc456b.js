(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{123:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return i})),t.d(n,"metadata",(function(){return l})),t.d(n,"rightToc",(function(){return o})),t.d(n,"default",(function(){return d}));var a=t(2),r=t(6),c=(t(0),t(142)),i={id:"reentrant-lock",title:"ReentrantLock \u7b80\u4ecb",author:"web1992",author_title:"web1992",author_url:"https://github.com/web1992",author_image_url:"https://avatars3.githubusercontent.com/u/6828647?s=60&v=4",tags:["java"]},l={permalink:"/blog/reentrant-lock",editUrl:"https://github.com/web1992/blog/tree/master/blog/reentrant-lock.md",source:"@site/blog/reentrant-lock.md",description:"\u7b80\u4ecb",date:"2020-07-23T01:49:02.167Z",tags:[{label:"java",permalink:"/blog/tags/java"}],title:"ReentrantLock \u7b80\u4ecb",readingTime:8.27,truncated:!0,nextItem:{title:"k8s \u96c6\u7fa4\u7684\u4e8c\u8fdb\u5236\u5b89\u88c5",permalink:"/blog/kubernetes-install-bin"}},o=[{value:"\u7b80\u4ecb",id:"\u7b80\u4ecb",children:[]},{value:"ReentrantLock",id:"reentrantlock",children:[]},{value:"Lock interface",id:"lock-interface",children:[]},{value:"ReentrantLock.lock \u7684\u5b9e\u73b0",id:"reentrantlocklock-\u7684\u5b9e\u73b0",children:[]},{value:"AbstractQueuedSynchronizer.tryAcquire",id:"abstractqueuedsynchronizertryacquire",children:[{value:"AbstractQueuedSynchronizer.acquire",id:"abstractqueuedsynchronizeracquire",children:[]},{value:"AbstractQueuedSynchronizer.acquireQueued",id:"abstractqueuedsynchronizeracquirequeued",children:[]}]},{value:"ReentrantLock.unlock \u7684\u5b9e\u73b0",id:"reentrantlockunlock-\u7684\u5b9e\u73b0",children:[]},{value:"tryRelease",id:"tryrelease",children:[]},{value:"unparkSuccessor",id:"unparksuccessor",children:[]},{value:"waitStatus",id:"waitstatus",children:[]},{value:"\u516c\u5e73\u9501&amp;\u975e\u516c\u5e73\u9501\u7684\u5b9e\u73b0",id:"\u516c\u5e73\u9501\u975e\u516c\u5e73\u9501\u7684\u5b9e\u73b0",children:[{value:"NonfairSync",id:"nonfairsync",children:[]},{value:"FairSync",id:"fairsync",children:[]}]},{value:"demo",id:"demo",children:[]},{value:"Link",id:"link",children:[]}],u={rightToc:o};function d(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(c.b)("wrapper",Object(a.a)({},u,t,{components:n,mdxType:"MDXLayout"}),Object(c.b)("h2",{id:"\u7b80\u4ecb"},"\u7b80\u4ecb"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ReentrantLock")," \u63d0\u4f9b\u4e86\u548c ",Object(c.b)("inlineCode",{parentName:"li"},"synchronized")," \u540c\u6837\u7684\u8bed\u4e49\uff0c\u4f46\u662f\u6269\u5c55\u4e86 ",Object(c.b)("inlineCode",{parentName:"li"},"synchronized")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ReentrantLock")," \u53ef\u4ee5\u91cd\u5165\uff0c\u540c\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u591a\u6b21\u83b7\u53d6\u9501"),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ReentrantLock")," \u5b9e\u73b0\u4e86 ",Object(c.b)("inlineCode",{parentName:"li"},"\u516c\u5e73\u9501")," & ",Object(c.b)("inlineCode",{parentName:"li"},"\u975e\u516c\u5e73\u9501")," \u7684\u8bed\u4e49"),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ReentrantLock")," \u5fc5\u987b\u4f7f\u7528 ",Object(c.b)("inlineCode",{parentName:"li"},"try"),"\u52a0\u9501\uff0c",Object(c.b)("inlineCode",{parentName:"li"},"finally")," \u6765\u91ca\u653e\u9501"),Object(c.b)("li",{parentName:"ul"},Object(c.b)("inlineCode",{parentName:"li"},"ReentrantLock")," \u53ef\u4ee5\u4f7f\u7528 ",Object(c.b)("inlineCode",{parentName:"li"},"tryLock")," \u8bbe\u7f6e\u9501\u7684\u8d85\u65f6\u65f6\u95f4")),Object(c.b)("h2",{id:"reentrantlock"},"ReentrantLock"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#%E7%AE%80%E4%BB%8B"}),"\u7b80\u4ecb")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#reentrantlock"}),"ReentrantLock")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#lock-interface"}),"Lock interface")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#reentrantlocklock-%E7%9A%84%E5%AE%9E%E7%8E%B0"}),"ReentrantLock.lock \u7684\u5b9e\u73b0")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#abstractqueuedsynchronizertryacquire"}),"AbstractQueuedSynchronizer.tryAcquire"),Object(c.b)("ul",{parentName:"li"},Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#abstractqueuedsynchronizeracquire"}),"AbstractQueuedSynchronizer.acquire")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#abstractqueuedsynchronizeracquirequeued"}),"AbstractQueuedSynchronizer.acquireQueued")))),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#reentrantlockunlock-%E7%9A%84%E5%AE%9E%E7%8E%B0"}),"ReentrantLock.unlock \u7684\u5b9e\u73b0")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#tryrelease"}),"tryRelease")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#unparksuccessor"}),"unparkSuccessor")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#waitstatus"}),"waitStatus")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#%E5%85%AC%E5%B9%B3%E9%94%81%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0"}),"\u516c\u5e73\u9501&\u975e\u516c\u5e73\u9501\u7684\u5b9e\u73b0"),Object(c.b)("ul",{parentName:"li"},Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#nonfairsync"}),"NonfairSync")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#fairsync"}),"FairSync")))),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#demo"}),"demo")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"#link"}),"Link"))),Object(c.b)("h2",{id:"lock-interface"},"Lock interface"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// \u8fd9\u91cc\u770b\u4e0b Lock\u63a5\u53e3\u7684\u5b9a\u4e49\n// lock \u7528\u6765\u83b7\u53d6\u9501\n// unlock \u7528\u6765\u91ca\u653e\u9501\n// Condition \u8d1f\u8d23\u7ebf\u7a0b\u7684\u963b\u585e\u548c\u5524\u9192\npublic interface Lock {\n    void lock();\n    void lockInterruptibly() throws InterruptedException;\n    boolean tryLock();\n    boolean tryLock(long time, TimeUnit unit) throws InterruptedException;\n    void unlock();\n    Condition newCondition();\n}\n")),Object(c.b)("p",null,"\u4e0b\u9762\u6211\u4eec\u4ece ",Object(c.b)("inlineCode",{parentName:"p"},"lock")," \u548c ",Object(c.b)("inlineCode",{parentName:"p"},"unlock")," \u53bb\u5206\u6790\u5b9e\u73b0\u8fc7\u7a0b"),Object(c.b)("h2",{id:"reentrantlocklock-\u7684\u5b9e\u73b0"},"ReentrantLock.lock \u7684\u5b9e\u73b0"),Object(c.b)("p",null,"\u5148\u770b\u4e0b ",Object(c.b)("inlineCode",{parentName:"p"},"ReentrantLock.lock")," \u65b9\u6cd5\u7684\u8c03\u7528\u94fe"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"ReentrantLock.lock -> ReentrantLock.Sync.lock\n    -> compareAndSetState -> \u6210\u529f -> \u7ed3\u675f\n                        |\n                        | -> \u5931\u8d25 -> acquire\n                                 -> tryAcquire\n                                 -> addWaiter\n                                 -> acquireQueued\n                                 -> tryAcquire -> \u6210\u529f  -> setHead -> cancelAcquire -> \u7ed3\u675f\n                                                |\n                                                |-> \u5931\u8d25  -> shouldParkAfterFailedAcquire\n                                                         -> parkAndCheckInterrupt\n                                                         -> cancelAcquire\n                                                         -> \u7ed3\u675f\n")),Object(c.b)("p",null,"\u4e0a\u9762\u7684 ",Object(c.b)("inlineCode",{parentName:"p"},"tryAcquire")," \u65b9\u6cd5\u4f5c\u7528\u662f\u4fee\u6539(\u4f7f\u7528cas) ",Object(c.b)("inlineCode",{parentName:"p"},"AbstractQueuedSynchronizer")," \u7684 ",Object(c.b)("inlineCode",{parentName:"p"},"state")," \u7684\u72b6\u6001"),Object(c.b)("p",null,"\u4fee\u6539\u6210\u529f\uff1a\u8bf4\u660e\u7ade\u4e89\u5230\u4e86\u9501\uff0c\u90a3\u4e48\u8be5\u7ebf\u7a0b\u7ee7\u7eed\u6267\u884c\n\u4fee\u6539\u5931\u8d25\uff1a\u7ade\u4e89\u9501\u5931\u8d25\uff0c\u90a3\u4e48\u8be5\u7ebf\u7a0b\u6267\u884c\u4e0b\u9762\u7684 ",Object(c.b)("inlineCode",{parentName:"p"},"shouldParkAfterFailedAcquire")," & ",Object(c.b)("inlineCode",{parentName:"p"},"parkAndCheckInterrupt")," \u65b9\u6cd5\u8fdb\u5165\u963b\u585e\u72b6\u6001"),Object(c.b)("p",null,"\u5bf9\u4e0a\u9762\u7684\u65b9\u6cd5\u8c03\u7528\u94fe\u7684\u5206\u652f\uff0c\u6211\u8fd9\u91cc\u628a\u4ed6\u4eec\u5206\u4e3a\u4e8c\u7c7b\uff0c\u65b9\u4fbf\u7406\u89e3"),Object(c.b)("p",null,"\u4e00\u7c7b\u662f\u4fee\u6539 ",Object(c.b)("inlineCode",{parentName:"p"},"state")," \u53d8\u91cf\u7684\u64cd\u4f5c"),Object(c.b)("p",null,"\u53e6\u4e00\u7c7b\u662f\u6267\u884c ",Object(c.b)("inlineCode",{parentName:"p"},"\u5165\u961f")," \u7684\u64cd\u4f5c"),Object(c.b)("p",null,"\u8fd9\u4e5f\u662f ",Object(c.b)("inlineCode",{parentName:"p"},"AbstractQueuedSynchronizer")," \u7684\u6838\u5fc3\u601d\u8def\uff1a",Object(c.b)("strong",{parentName:"p"},"\u5728\u7ebf\u7a0b\u4e4b\u95f4\u53bb\u7ade\u4e89\u83b7\u53d6\u9501\u7684\u65f6\u5019\uff0c\u5148\u5c1d\u8bd5\u4fee\u6539 ",Object(c.b)("inlineCode",{parentName:"strong"},"state")," \u5b57\u6bb5\u7684\u503c\uff0c\u5982\u679c\u4fee\u6539\u6210\u529f\uff0c\u83b7\u53d6\u9501\u5c31\u662f\u6210\u529f\u7684\uff0c\u8be5\u7ebf\u7a0b\u7ee7\u7eed\u6267\u884c\uff0c\u5931\u8d25\u5c31\u628a\u5f53\u524d\u7ebf\u7a0b\u653e\u5165\u961f\u5217\uff0c\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff0c\u7b49\u4ed6\u5176\u4ed6\u7ebf\u7a0b\u5524\u9192")),Object(c.b)("p",null,"\u4ee5\u516c\u5e73\u9501\u4e3a\u4f8b\uff0c\u770b\u4e0b ",Object(c.b)("inlineCode",{parentName:"p"},"tryAcquire")," \u65b9\u6cd5\u7684\u5b9e\u73b0\uff08\u5c5e\u4e8e\u4fee\u6539 ",Object(c.b)("inlineCode",{parentName:"p"},"state")," \u8fd9\u4e00\u7c7b\u7684\u64cd\u4f5c\uff09"),Object(c.b)("h2",{id:"abstractqueuedsynchronizertryacquire"},"AbstractQueuedSynchronizer.tryAcquire"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'protected final boolean tryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();// c=0 \u610f\u5473\u7740\u6ca1\u6709\u7ebf\u7a0b\u83b7\u53d6\u9501\n    if (c == 0) {\n        // hasQueuedPredecessors \u662f\u5224\u65ad\u662f\u5426\u6709\u5176\u4ed6\u7ebf\u7a0b\u5728\u6392\u961f\uff0c\u4e3a\u4e86\u5b9e\u73b0\u516c\u5e73\u9501\u7684\u8bed\u4e49\n        // \u4e0b\u9762\u5c1d\u8bd5\u4fee\u6539 state \u7684\u503c\uff0c\u5982\u679c\u4fee\u6539\u6210\u529f\uff0c\u90a3\u4e48\u4ee3\u8868\u83b7\u53d6\u9501\u6210\u529f\n        if (!hasQueuedPredecessors() &&\n            compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    else if (current == getExclusiveOwnerThread()) {\n        // \u4e0d\u7b49\u4e8e0\uff0c\u8bf4\u660e\u5b58\u5728\u5176\u4ed6\u7ebf\u7a0b\u5df2\u7ecf\u83b7\u53d6\u9501\u4e86\uff0c\u5224\u65ad\u662f\u4e0d\u662f\u540c\u4e00\u4e2a\u7ebf\u7a0b\n        // \u5982\u679c\u662f\uff0c\u6267\u884c state +1\n        // \u4e5f\u5c31\u662f\u53ef\u91cd\u5165\u9501\u7684\u5b9e\u73b0\n        // \u5982\u679c\u4e4b\u524d\u83b7\u53d6\u9501\u7684\u7ebf\u7a0b\u548c\u5f53\u524d\u7ebf\u7a0b\u662f\u540c\u4e00\u4e2a\n        // \u5c31\u5bf9 state +1\n        // \u8fd9\u91cc setState \u76f4\u63a5\u8bbe\u7f6e\uff0c\u800c\u6ca1\u6709\u4f7f\u7528 cas\n        // \u662f\u56e0\u4e3a\u5f53\u5730\u7ebf\u7a0b\u5df2\u7ecf\u83b7\u53d6\u9501\u4e86\uff0c\u5176\u4ed6\u7ebf\u7a0b\u4e0d\u4f1a\u4fee\u6539 state \u7684\u503c\n        // \u5982\u679c\u7ebf\u7a0bA\u6267\u884c\u4e86\u4e24\u6b21 lock \u65b9\u6cd5\uff0c\u90a3\u4e48\u5fc5\u987b\u6267\u884c\u4e24\u6b21 unlock\n        // \u7ebf\u7a0bA\u624d\u4f1a\u91ca\u653e\u9501\n        // \u539f\u56e0\u4e5f\u5f88\u7b80\u5355\uff0c\u6267\u884c\u4e86\u4e24\u6b21 lock \u4e4b\u540e state=2\n        // \u5982\u679c\u53ea\u6267\u884c\u4e00\u6b21 unlock \uff0c\u6b64\u65f6state=1 ,\u4e0d\u4e3a 0\n        // \u5176\u4ed6\u7ebf\u7a0b\u662f\u65e0\u6cd5\u83b7\u53d6\u9501\n        int nextc = c + acquires;\n        if (nextc < 0)\n            throw new Error("Maximum lock count exceeded");\n        setState(nextc);\n        return true;\n    }\n    return false;\n}\n')),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"\u9677\u9631\uff1a \u5982\u679c\u4f7f\u7528\u4e86",Object(c.b)("inlineCode",{parentName:"p"},"\u4e24\u6b21")," ",Object(c.b)("inlineCode",{parentName:"p"},"try")," \u83b7\u53d6\u9501\uff0c\u90a3\u4e48\u5fc5\u987b\u4f7f\u7528",Object(c.b)("inlineCode",{parentName:"p"},"\u4e24\u6b21")," ",Object(c.b)("inlineCode",{parentName:"p"},"unlock")," \u53bb\u91ca\u653e\u9501\uff0c\u5426\u5219\u5176\u4ed6\u7ebf\u7a0b\u4f1a\u83b7\u53d6\u4e0d\u5230\u9501")),Object(c.b)("h3",{id:"abstractqueuedsynchronizeracquire"},"AbstractQueuedSynchronizer.acquire"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"acquire")," \u65b9\u6cd5\u5c5e\u4e8e\u7b2c\u4e8c\u7c7b\u64cd\u4f5c(\u6267\u884c ",Object(c.b)("inlineCode",{parentName:"p"},"\u5165\u961f")," \u7684\u64cd\u4f5c)"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// AbstractQueuedSynchronizer\n// 1.tryAcquire \u5c1d\u8bd5\u83b7\u53d6\u9501\n//   \u5982\u679c\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u90a3\u4e48\u628a\u5f53\u524d\u7ebf\u7a0b\u8fdb\u5165\u961f\u5217\uff08\u6267\u884caddWaiter\uff09\n// 2.addWaiter \u628a\u5f53\u524d\u7ebf\u7a0b\u5c01\u88c5\u6210 Node \u653e\u5165\u961f\u5217\n// 3.acquireQueued \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\npublic final void acquire(int arg) {\n    if (!tryAcquire(arg) &&\n        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))\n        selfInterrupt();\n}\n")),Object(c.b)("h3",{id:"abstractqueuedsynchronizeracquirequeued"},"AbstractQueuedSynchronizer.acquireQueued"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"acquireQueued")," \u65b9\u6cd5\u6267\u884c\u4e86 ",Object(c.b)("strong",{parentName:"p"},"\u4fee\u6539 ",Object(c.b)("inlineCode",{parentName:"strong"},"state")," \u7684\u64cd\u4f5c")," \u548c ",Object(c.b)("strong",{parentName:"p"},"\u963b\u585e\u83b7\u53d6\u9501\u5931\u8d25\u7684\u7ebf\u7a0b\u7684\u64cd\u4f5c")),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// AbstractQueuedSynchronizer#acquireQueued\n// \u8fd9\u4e2a\u65b9\u6cd5\u505a\u4e86\u4e0b\u9762\u51e0\u4ef6\u4e8b\uff1a\n// 1.\u83b7\u53d6\u9501\n//   tryAcquire \u662f\u5728 for(;;) \u4e2d\u6267\u884c\u7684\n//   \u5f53\u524d\u7ebf\u7a0b\u5728\u7b2c\u4e00\u6b21\u8c03\u7528 tryAcquire \u65f6\uff0c\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u5c31\u4f1a\u6267\u884c parkAndCheckInterrupt\n//   \u8fdb\u5165\u963b\u585e\uff0c\u5f53\u518d\u6b21\u88ab\u5524\u9192\u65f6\uff0c\u518d\u6b21\u8c03\u7528 tryAcquire \u83b7\u53d6\u9501,\u83b7\u53d6\u5931\u8d25\uff0c\u518d\u6b21\u8fdb\u5165\u963b\u585e\n//   \u6210\u529f\u6267\u884c return \u7ed3\u675f\u5faa\u73af\n// 2.[\u83b7\u53d6\u9501\u6210\u529f] \u4fee\u6539 \u961f\u5217\u7684 head\n//    \u5728\u6267\u884c tryAcquire \u6210\u529f\u4e4b\u540e\uff0c\u8868\u793a\u5f53\u524d\u7ebf\u7a0b\u83b7\u53d6\u9501\u6210\u529f\u4e86\n//    \u4fee\u6539\u961f\u5217\u7684 head \u4e3a\u5f53\u524d\u7ebf\u7a0b\uff08\u65e7 head \u51fa\u961f\u5217\uff0c\u5f53\u524d\u7ebf\u7a0b\u53d8\u6210 head\uff09\n// 3.[\u83b7\u53d6\u9501\u5931\u8d25] \u66f4\u65b0\u524d\u4e00\u4e2a node \u7684 waitStatus = Node.SIGNAL\n//   acquireQueued \u65b9\u6cd5\u662f\u5728 tryAcquire \u6267\u884c\u5931\u8d25\u4e4b\u540e\u6267\u884c\u7684(\u83b7\u53d6\u9501\u5931\u8d25)\n//   \u7136\u540e\u901a\u8fc7 shouldParkAfterFailedAcquire \u65b9\u6cd5\u83b7\u53d6\u524d\u4e00\u4e2anode \u7684 waitStatus\n//   \u5982\u679c\u4e0d\u662f Node.SIGNAL \u5c31\u66f4\u65b0\u4e3a Node.SIGNAL\n// 4.[\u83b7\u53d6\u9501\u5931\u8d25] \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\n//   parkAndCheckInterrupt \u65b9\u6cd5\u4f7f\u7528 LockSupport.park(this); \u963b\u585e\u5f53\u524d\u7ebf\u7a0b\nfinal boolean acquireQueued(final Node node, int arg) {\n    boolean failed = true;\n    try {\n        boolean interrupted = false;\n        for (;;) {\n            // \u901a\u8fc7\u4e0b\u9762\u7684 enq \u53ef\u77e5\uff0c\u961f\u5217\u7684 head \u521d\u59cb\u5316\u4e4b\u540e\uff0c\u65b0\u7684node \u4f1a\u5728 head \u540e\u9762\n            // \u7531\u4e8e\u5e76\u53d1\u7684\u539f\u56e0\uff0c\u65b0\u7684node \u4e0d\u4e00\u5b9a\u4ee5\u540e\u662f\u7d27\u6328\u7740head \u7684\uff0c\u6709\u4e0b\u9762\u4e24\u79cd\u60c5\u51b5\uff1a\n            // head <- node \u60c5\u51b51\uff1anode \u5728head \u540e\u9762\n            // head <- nodeA <- node \u60c5\u51b52: node \u4e0d\u5728head \u540e\u9762\uff0c\u4e2d\u95f4\u6709 nodeA \u5b58\u5728\n            final Node p = node.predecessor();// \u83b7\u53d6\u5f53\u524dnode \u7684\u524d\u4e00\u4e2a\u5143\u7d20\n            if (p == head && tryAcquire(arg)) {// \u4e0e head \u5bf9\u6bd4\uff0c\u5982\u679c\u76f8\u7b49\uff0c\u8bf4\u660e node \u662f\u961f\u5217\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u5c1d\u8bd5\u83b7\u53d6\u9501\uff08\u4e5f\u5c31\u662f\u60c5\u51b51\uff09\n                setHead(node);// \u83b7\u53d6\u6210\u529f,\u4fee\u6539head (\u8fd9\u91cc\u5e76\u6ca1\u6709\u4f7f\u7528cas \u53bb\u4fee\u6539)\n                p.next = null; // help GC\n                failed = false;\n                return interrupted;\n            }\n            if (shouldParkAfterFailedAcquire(p, node) &&\n                parkAndCheckInterrupt())// \u8fd9\u91cc\u4f1a\u963b\u585e\uff08\u963b\u585e\u5f53\u524d\u7ebf\u7a0b\uff09\n                interrupted = true;\n        }\n    } finally {\n        if (failed)\n            cancelAcquire(node);\n    }\n}\n// \u4fee\u6539 head\n// \u8fd9\u91cc\u5e76\u6ca1\u6709\u4f7f\u7528 cas \u53bb\u4fee\u6539\u7684\u539f\u56e0\u662f\uff1a\n// \u5176\u4ed6\u7ebf\u7ebf\u7a0b\u5728 tryAcquire \u7684\u65f6\u5019\u5931\u8d25\u4e86(\u5728 ReentrantLock \u7684\u5b9e\u73b0\u4e2d\u5c31\u662f\u4fee\u6539 state \u7684\u503c)\n// \u4e5f\u5c31\u662f\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u90a3\u4e48\u4ee3\u7801\u4f1a\u7ee7\u7eed\u6267\u884c parkAndCheckInterrupt \u65b9\u6cd5\uff0c\u8fdb\u884c\u963b\u585e\n// \u5176\u4ed6\u7ebf\u7a0b\u5c31\u8fdb\u884c\u4e86\u963b\u585e\uff0c\u56e0\u6b64\u6b64\u65f6\u4e0d\u4f1a\u5b58\u5728\u7ade\u4e89\u53bb\u4fee\u6539 head \u7684\u60c5\u51b5\nprivate void setHead(Node node) {\n    head = node;\n    node.thread = null;\n    node.prev = null;\n}\n\n// \u770b\u4e0b head \u548c tail \u7684\u6ce8\u91ca\n\n/**\n * Head of the wait queue, lazily initialized.  Except for\n * initialization, it is modified only via method setHead.  Note:\n * If head exists, its waitStatus is guaranteed not to be\n * CANCELLED.\n */\nprivate transient volatile Node head;\n\n/**\n * Tail of the wait queue, lazily initialized.  Modified only via\n * method enq to add new wait node.\n */\nprivate transient volatile Node tail;\n\n// \u4e0a\u9762\u7684 head \u548c tail \u662f AbstractQueuedSynchronizer \u7684\u53d8\u91cf\n// \u4ed6\u4eec\u90fd\u662f lazily initialized \u7684\uff0c\u4e5f\u662f\u8bf4\uff0c\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019 head \u548c tail \u90fd\u662f null \u9700\u8981\u8fdb\u884c\u521d\u59cb\u5316\n// \u800c AbstractQueuedSynchronizer#enq \u65b9\u6cd5\u5305\u542b\u4e86\u521d\u59cb\u5316\u7684\u64cd\u4f5c\n// compareAndSetHead \u65b9\u6cd5\u5148\u8fdb\u884c head \u7684\u521d\u59cb\u5316\n// head \u521d\u59cb\u5316\u6210\u529f\u4e4b\u540e\uff0c\u65b0\u7684 node \u8fdb\u884c\u5165\u961f\u64cd\u4f5c\nprivate Node enq(final Node node) {\n    for (;;) {\n        Node t = tail;\n        if (t == null) { // Must initialize \u8fdb\u884c\u521d\u59cb\u5316\n            if (compareAndSetHead(new Node()))// \u521d\u59cb\u5316 head\n                tail = head;// head  \u548c tail \u662f\u4e00\u6837\u7684\uff0c\u8fd9\u91cc\u6ca1\u6709return \u56e0\u6b64\u4e0b\u6b21\u5faa\u73af\u4f1a\u518d\u6b21\u6267\u884c else \u4e2d\u7684\u903b\u8f91\n        } else {\n            node.prev = t;// \u4fee\u6539node.prev=tail \u56e0\u4e3a\u662f\u5165\u961f\u64cd\u4f5c\uff0c\u6240\u4ee5node \u8981\u5728\u961f\u7684\u5c3e\u90e8\n            if (compareAndSetTail(t, node)) {//\u5165\u961f\u6210\u529f,\u961f\u5217\u5df2\u7ecf\u5f62\u6210\uff0c\u4fee\u6539 tail.next\n                t.next = node;\n                return t;\n            }\n        }\n    }\n}\n")),Object(c.b)("h2",{id:"reentrantlockunlock-\u7684\u5b9e\u73b0"},"ReentrantLock.unlock \u7684\u5b9e\u73b0"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"ReentrantLock.unlock")," \u65b9\u6cd5\u8c03\u7528\u94fe"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"ReentrantLock.unlock\n  -> ReentrantLock.Sync.release\n  -> tryRelease\n  -> unparkSuccessor\n")),Object(c.b)("h2",{id:"tryrelease"},"tryRelease"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"\n// \u6267\u884c release\npublic void unlock() {\n    sync.release(1);\n}\n// \u6267\u884c tryRelease\n// \u5982\u679c\u6210\u529f\u6267\u884c unparkSuccessor\npublic final boolean release(int arg) {\n    if (tryRelease(arg)) {\n        Node h = head;\n        if (h != null && h.waitStatus != 0)\n            unparkSuccessor(h);// \u628a\u961f\u5217\u7684 head \u7ed9 unparkSuccessor \u65b9\u6cd5\n        return true;\n    }\n    return false;\n}\n// tryRelease \u5c31\u662f\u4fee\u6539 state \u7684\u503c(state-1)\nprotected final boolean tryRelease(int releases) {\n    int c = getState() - releases;\n    if (Thread.currentThread() != getExclusiveOwnerThread())\n        throw new IllegalMonitorStateException();\n    boolean free = false;\n    if (c == 0) {\n        free = true;\n        setExclusiveOwnerThread(null);\n    }\n    setState(c);\n    return free;\n}\n// \u8fd9\u91cc\u4fee\u6539 state \u6ca1\u6709\u4f7f\u7528 CAS \u662f\u56e0\u4e3a\uff1a\n// \u5f53\u524d\u7ebf\u7a0b\u80af\u5b9a\u662f\u83b7\u53d6\u9501\u6210\u529f\u7684\uff0c\u5176\u4ed6\u7ebf\u7a0b\u80af\u5b9a\u662f\u963b\u585e\u72b6\u6001\n// \u4e0d\u5b58\u5728\u5176\u4ed6\u7ebf\u7a0b\u540c\u65f6\u4fee\u6539 state \u7684\u60c5\u51b5\uff0c\u56e0\u6b64\u76f4\u63a5\u4fee\u6539\u662f\u53ef\u4ee5\u7684\nprotected final void setState(int newState) {\n    state = newState;\n}\n")),Object(c.b)("h2",{id:"unparksuccessor"},"unparkSuccessor"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"/**\n * Wakes up node's successor, if one exists.\n *\n * @param node the node\n */\n// unparkSuccessor \u65b9\u6cd5\u4ece head \u627e\u5230\u4e0b\u4e00\u4e2anode\n// \u5982\u679c\u4e0d\u4e3a\u7a7a\u5b58\u5728\u5c31\u5524\u9192node \u7ed1\u5b9a\u7684\u7ebf\u7a0b\n// \u4e3a\u7a7a\uff0c\u4ecetail\u627e\u5230\u4e00\u4e2a\u5408\u9002\u7684 node \u8fdb\u884c\u7ebf\u7a0b\u5524\u9192\nprivate void unparkSuccessor(Node node) {\n    /*\n     * If status is negative (i.e., possibly needing signal) try\n     * to clear in anticipation of signalling.  It is OK if this\n     * fails or if status is changed by waiting thread.\n     */\n    int ws = node.waitStatus;// \u8fd9\u91cc\u7684 node \u5176\u5b9e\u662f head\n    if (ws < 0)// \u53ef\u80fd\u5b58\u5728 waitStatus \u5c0f\u4e8e0\u7684\u60c5\u51b5\uff0c\u5982\u679c\u662f\u4fee\u6539\u4e3a0\n        compareAndSetWaitStatus(node, ws, 0);\n    /*\n     * Thread to unpark is held in successor, which is normally\n     * just the next node.  But if cancelled or apparently null,\n     * traverse backwards from tail to find the actual\n     * non-cancelled successor.\n     */\n    Node s = node.next;\n    // \u5982\u679c head \u7684\u4e0b\u4e00\u4e2a node \u4e3a\u7a7a\uff0c\u4ecetail \u627e\u5230\u4e00\u4e2a\u8fdb\u884c\u9501\u7684\u91ca\u653e\n    if (s == null || s.waitStatus > 0) {// \u5927\u4e8e 0 waitStatus=CANCELLED \u53d6\u6d88\u72b6\u6001\n        s = null;\n        // \u4ece tail \u961f\u5c3e\u5f00\u59cb\u5bfb\u627e\n        for (Node t = tail; t != null && t != node; t = t.prev)\n            if (t.waitStatus <= 0)\n                s = t;\n    }\n    if (s != null)\n        LockSupport.unpark(s.thread);\n}\n")),Object(c.b)("h2",{id:"waitstatus"},"waitStatus"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"waitStatus")," \u7684\u503c&\u542b\u4e49"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"/** waitStatus value to indicate thread has cancelled */\nstatic final int CANCELLED =  1;\n/** waitStatus value to indicate successor's thread needs unparking */\nstatic final int SIGNAL    = -1;\n/** waitStatus value to indicate thread is waiting on condition */\nstatic final int CONDITION = -2;\n/**\n * waitStatus value to indicate the next acquireShared should\n * unconditionally propagate\n */\nstatic final int PROPAGATE = -3;\n")),Object(c.b)("h2",{id:"\u516c\u5e73\u9501\u975e\u516c\u5e73\u9501\u7684\u5b9e\u73b0"},"\u516c\u5e73\u9501&\u975e\u516c\u5e73\u9501\u7684\u5b9e\u73b0"),Object(c.b)("p",null,Object(c.b)("inlineCode",{parentName:"p"},"ReentrantLock")," \u4f7f\u7528\u4e24\u4e2a\u5185\u90e8\u7c7b ",Object(c.b)("inlineCode",{parentName:"p"},"NonfairSync")," \u548c ",Object(c.b)("inlineCode",{parentName:"p"},"FairSync")," \u6765\u5b9e\u73b0\u975e\u516c\u5e73\u9501\u548c\u516c\u5e73\u9501"),Object(c.b)("p",null,Object(c.b)("img",Object(a.a)({parentName:"p"},{src:"./images/Sync.png",alt:"Sync.png"}))),Object(c.b)("h3",{id:"nonfairsync"},"NonfairSync"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'static final class NonfairSync extends Sync {\n    private static final long serialVersionUID = 7316153563782823691L;\n    /**\n     * Performs lock.  Try immediate barge, backing up to normal\n     * acquire on failure.\n     */\n    final void lock() {\n        // \u975e\u516c\u5e73\u9501\u5728\u83b7\u53d6\u9501\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u5c1d\u8bd5\u4fee\u6539 AbstractQueuedSynchronizer \u7684 state \u5b57\u6bb5\u6765\u83b7\u53d6\u9501\n        // \u5982\u679c\u4fee\u6539\u6210\u529f\uff0c\u90a3\u4e48\u5c31\u83b7\u53d6\u9501\u6210\u529f\n        if (compareAndSetState(0, 1))\n            setExclusiveOwnerThread(Thread.currentThread());\n        else\n            acquire(1);// \u5c1d\u8bd5\u83b7\u53d6\u9501\u5931\u8d25\uff0c\u5c31\u53bb\u83b7\u53d6\u9501\n    }\n    protected final boolean tryAcquire(int acquires) {\n        return nonfairTryAcquire(acquires); // \u6267\u884c nonfairTryAcquire \u65b9\u6cd5\u83b7\u53d6\u9501\n    }\n}\n\n// Sync#nonfairTryAcquire\n// nonfairTryAcquire \u4e0e FairSync \u7684 tryAcquire \u5c11\u4e86\u4e00\u4e2a !hasQueuedPredecessors() \u8fd9\u4e2a\u64cd\u4f5c\n// hasQueuedPredecessors \u65b9\u6cd5\u4f1a\u68c0\u67e5\u662f\u5426\u6709\u7ebf\u7a0b\u5728\u961f\u5217\u4e2d\uff0c\u5982\u679c\u6ca1\u6709\u624d\u4f1a\u5c1d\u8bd5\u83b7\u53d6\u9501\nfinal boolean nonfairTryAcquire(int acquires) {\n    final Thread current = Thread.currentThread();\n    int c = getState();\n    if (c == 0) {\n        if (compareAndSetState(0, acquires)) {\n            setExclusiveOwnerThread(current);\n            return true;\n        }\n    }\n    else if (current == getExclusiveOwnerThread()) {\n        int nextc = c + acquires;\n        if (nextc < 0) // overflow\n            throw new Error("Maximum lock count exceeded");\n        setState(nextc);\n        return true;\n    }\n    return false;\n}\n')),Object(c.b)("h3",{id:"fairsync"},"FairSync"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'static final class FairSync extends Sync {\n    private static final long serialVersionUID = -3000897897090466540L;\n    final void lock() {\n        acquire(1);// \u8fd9\u91cc\u548c NonfairSync \u7684 lock  \u65b9\u6cd5\u5bf9\u6bd4,\u5c11\u4e86\u4e00\u6b21\u5c1d\u8bd5\u7684\u52a8\u4f5c\n    }\n    /**\n     * Fair version of tryAcquire.  Don\'t grant access unless\n     * recursive call or no waiters or is first.\n     */\n    protected final boolean tryAcquire(int acquires) {\n        final Thread current = Thread.currentThread();\n        int c = getState();\n        if (c == 0) {\n            if (!hasQueuedPredecessors() &&// \u6ca1\u6709\u6392\u961f\u7684\u7ebf\u7a0b\u624d\u5c1d\u8bd5\u83b7\u53d6\u9501\uff0c\u5426\u5219\u83b7\u53d6\u9501\u5931\u8d25\n                compareAndSetState(0, acquires)) {\n                setExclusiveOwnerThread(current);\n                return true;\n            }\n        }\n        else if (current == getExclusiveOwnerThread()) {\n            int nextc = c + acquires;\n            if (nextc < 0)\n                throw new Error("Maximum lock count exceeded");\n            setState(nextc);\n            return true;\n        }\n        return false;\n    }\n}\n\n// 1. \u6709\u7ebf\u7a0b\u5728\u6392\u961f\n// 2. \u6392\u961f\u7684\u7ebf\u7a0b\u4e0e\u5f53\u524d\u7ebf\u7a0b\u4e0d\u662f\u540c\u4e00\u4e2a\npublic final boolean hasQueuedPredecessors() {\n    // The correctness of this depends on head being initialized\n    // before tail and on head.next being accurate if the current\n    // thread is first in queue.\n    Node t = tail; // Read fields in reverse initialization order\n    Node h = head;\n    Node s;\n    return h != t &&\n        ((s = h.next) == null || s.thread != Thread.currentThread());\n}\n')),Object(c.b)("h2",{id:"demo"},"demo"),Object(c.b)("pre",null,Object(c.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'// \u4e00\u4e2a\u963b\u585e\u961f\u5217\u5b9e\u73b0\nclass BlockArray<E> {\n\n    Object[] element;\n\n\n    int size;\n    int count;\n    int putprt;\n    int takeptr;\n\n    public BlockArray(int size) {\n        this.size = size;\n        element = new Object[size];\n    }\n\n\n    final ReentrantLock lock = new ReentrantLock();\n\n    final Condition empty = lock.newCondition();\n\n    final Condition full = lock.newCondition();\n\n\n    public E put(E e) throws InterruptedException {\n        lock.lock();\n        try {\n            while (count == size) {\n                full.await();\n            }\n            element[putprt++] = e;\n            if (putprt == size) {\n                putprt = 0;\n            }\n            ++count;\n            empty.signal();\n        } finally {\n            lock.unlock();\n        }\n\n        return e;\n    }\n\n    public E take() throws InterruptedException {\n        E e = null;\n        lock.lock();\n        try {\n            while (count == 0) {\n                empty.await();\n            }\n            e = (E) element[takeptr++];\n            if (takeptr == size) {\n                takeptr = 0;\n            }\n            --count;\n            full.signal();\n        } finally {\n            lock.unlock();\n        }\n        return e;\n    }\n\n}\n    // test\n    public static void main(String[] args) {\n        BlockArray<Integer> blockArray = new BlockArray(5);\n\n        new Thread(() -> {\n            try {\n                while (true) {\n                    System.out.println("get " + blockArray.take());\n                }\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n        }).start();\n\n        IntStream.range(0, 10).forEach(i -> {\n            try {\n                blockArray.put(i);\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n            }\n        });\n    }\n\n')),Object(c.b)("h2",{id:"link"},"Link"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"condition.md"}),"condition.md")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"count-down-latch.md"}),"count-down-latch.md")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"aqs.md"}),"aqs.md")),Object(c.b)("li",{parentName:"ul"},Object(c.b)("a",Object(a.a)({parentName:"li"},{href:"https://tech.meituan.com/2018/11/15/java-lock.html"}),"https://tech.meituan.com/2018/11/15/java-lock.html"))))}d.isMDXComponent=!0},142:function(e,n,t){"use strict";t.d(n,"a",(function(){return b})),t.d(n,"b",(function(){return h}));var a=t(0),r=t.n(a);function c(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){c(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},c=Object.keys(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(a=0;a<c.length;a++)t=c[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var u=r.a.createContext({}),d=function(e){var n=r.a.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},b=function(e){var n=d(e.components);return r.a.createElement(u.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},p=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,c=e.originalType,i=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),b=d(t),p=a,h=b["".concat(i,".").concat(p)]||b[p]||s[p]||c;return t?r.a.createElement(h,l(l({ref:n},u),{},{components:t})):r.a.createElement(h,l({ref:n},u))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var c=t.length,i=new Array(c);i[0]=p;var l={};for(var o in n)hasOwnProperty.call(n,o)&&(l[o]=n[o]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var u=2;u<c;u++)i[u]=t[u];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,t)}p.displayName="MDXCreateElement"}}]);